name: RDP + RustDesk (clean)

on:
  workflow_dispatch:
    inputs:
      runtime_min:
        description: "Minutes to keep alive"
        required: false
        default: "120"

permissions: { contents: read }

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: Create Admin Users
        run: |
          foreach ($u in @("Sunni1","Sunni2")){
            $p = ConvertTo-SecureString "Sunn1!GitHub2025#" -AsPlainText -Force
            if (!(Get-LocalUser -Name $u -EA 0)){ New-LocalUser $u -Password $p -AccountNeverExpires }
            Add-LocalGroupMember -Group Administrators -Member $u
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          }
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Install RustDesk
        run: |
          $msi = "$env:TEMP\rd.msi"
          Invoke-WebRequest -Uri "https://github.com/rustdesk/rustdesk/releases/download/1.3.1/rustdesk-1.3.1-x86_64.msi" -OutFile $msi
          Start-Process msiexec -Arg "/i","`"$msi`"","/quiet","/norestart" -Wait
          21115..21119 | %{ netsh advfirewall firewall add rule name="RD-$_" dir=in action=allow protocol=TCP localport=$_ }
          netsh advfirewall firewall add rule name="RD-UDP" dir=in action=allow protocol=UDP localport=21116

      - name: Start RustDesk & Show Credentials
        run: |
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe"
          Start-Sleep 10
          $id = (Get-Content "$env:APPDATA\RustDesk\config\RustDesk2.toml" -EA 0 | sls id) -replace '\D',''
          $pw = (Get-Content "$env:APPDATA\RustDesk\config\RustDesk2.toml" -EA 0 | sls password) -replace '.+=(.+)','$1'
          Write-Host "==================================="
          Write-Host "RustDesk ID:  $id"
          Write-Host "Password:     $pw"
          Write-Host "==================================="

      - name: Keep Alive
        run: |
          $end = (Get-Date).AddMinutes([int]"${{ github.event.inputs.runtime_min }}")
          while ((Get-Date) -lt $end){
            Write-Host "Alive â€“ $(Get-Date)"
            Start-Sleep 60
          }
