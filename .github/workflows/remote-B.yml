name: RustDesk + Webhook A (Desktop CLI)

on:
  workflow_dispatch:
    inputs:
      rustdesk_password:
        description: "Senha do RustDesk"
        required: true
        default: "Sunni12345#"
      ngrok_token:
        description: "Token do Ngrok"
        required: true
        default: "37g5Li5Ku4vdBp9Aj3ff99eqL67_6fHotdD33DTeZgUKdz18B"
      
      # SEU LINK DO CDN (PYTHON)
      script_url:
        description: "Link do script python"
        required: true
        default: "https://sunni-files.b-cdn.net/usar_otimizado.py"
      
      webhook_secret:
        description: "Senha do Webhook"
        required: false
        default: "segredo_padrao_123"
      runtime_minutes:
        description: "Tempo de vida (min)"
        required: false
        default: "355"

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: pwsh

jobs:
  remote:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Install RustDesk
        run: |
          Write-Host "üì¶ Installing RustDesk..."
          $msi = "$env:TEMP\rustdesk.msi"
          Invoke-WebRequest "https://github.com/rustdesk/rustdesk/releases/download/1.3.1/rustdesk-1.3.1-x86_64.msi" -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i","`"$msi`"","/quiet","/norestart" -Wait
          Write-Host "‚úÖ RustDesk installed"

      - name: Configure RustDesk
        run: |
          Write-Host "üîß Setting password..."
          & "C:\Program Files\RustDesk\rustdesk.exe" --password "${{ inputs.rustdesk_password }}" 2>$null
          Start-Sleep 5
          Write-Host "‚úÖ Password set"

      - name: Get RustDesk ID
        run: |
          Write-Host "üÜî Getting ID..."
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe" -ArgumentList "--service"
          Start-Sleep 3
          $id = ""; for ($i = 1; $i -le 5; $i++) { try { $o = & "C:\Program Files\RustDesk\rustdesk.exe" --get-id 2>&1 | Out-String; $id = $o.Trim(); if ($id -match '^\d+$') { break } } catch {}; Start-Sleep 2 }
          if (-not ($id -match '^\d+$')) { $c="$env:APPDATA\RustDesk\config\RustDesk2.toml"; if(Test-Path $c){ $txt=Get-Content $c -Raw; if($txt -match 'id\s*=\s*"(\d+)"'){$id=$matches[1]} } }
          "RUSTDESK_ID=$id" | Out-File -Append $env:GITHUB_ENV
          Write-Host "‚úÖ RustDesk ID: $id"

      # --- DOWNLOAD 1: Otimiza√ß√£o (Salva no Desktop) ---
      - name: Run Optimization
        run: |
          Write-Host "‚ö° Optimization (Desktop)..."
          try {
            $url = "https://sunni-files.b-cdn.net/Otimization.cmd"
            # Caminho atualizado para o Desktop
            $path = "$env:USERPROFILE\Desktop\Otimization.cmd"
            
            Write-Host "   ‚¨áÔ∏è Baixando para $path..."
            Invoke-WebRequest -Uri $url -OutFile $path
            
            if (Test-Path $path) {
                Write-Host "   ‚öôÔ∏è Executando..."
                Start-Process cmd.exe -ArgumentList "/c `"$path`"" -Wait -NoNewWindow
                Write-Host "‚úÖ Otimiza√ß√£o conclu√≠da"
                # Opcional: Remove ou mant√©m o arquivo na √°rea de trabalho
                # Remove-Item $path -Force 
            } else {
                Write-Error "‚ùå Falha ao baixar Otimization.cmd"
            }
          } catch {
            Write-Host "‚ö†Ô∏è Erro otimiza√ß√£o: $_"
          }

      - name: Install Python Dependencies
        run: |
          Write-Host "üì¶ Instalando bibliotecas..."
          python -m pip install --upgrade pip --quiet
          
          # Depend√™ncias do Webhook
          python -m pip install flask flask-cors requests --quiet
          
          # Depend√™ncias do seu Script (Conforme solicitado)
          python -m pip install undetected-chromedriver selenium pyperclip pyautogui tls-client --quiet
          
          Write-Host "‚úÖ Depend√™ncias instaladas!"

      # --- DOWNLOAD 2: Script Python (Salva no Desktop) ---
      - name: Download Automation Script
        run: |
          Write-Host "‚¨áÔ∏è Baixando script Python para Desktop..."
          $url = "${{ inputs.script_url }}"
          # Caminho atualizado para o Desktop
          $dest = "$env:USERPROFILE\Desktop\usar_otimizado.py"
          
          try {
            Invoke-WebRequest -Uri $url -OutFile $dest
            Write-Host "‚úÖ Script baixado com sucesso em: $dest"
            
            if ((Get-Item $dest).Length -lt 100) {
                Write-Warning "‚ö†Ô∏è O arquivo baixado √© muito pequeno."
            }
          } catch {
            Write-Error "‚ùå Falha cr√≠tica ao baixar script."
            exit 1
          }

      - name: Start Command Server
        run: |
          $code = @'
          import sys
          import subprocess
          import os
          from flask import Flask, request, jsonify
          from flask_cors import CORS
          from datetime import datetime

          app = Flask(__name__)
          CORS(app, resources={r"/*": {"origins": "*"}})

          SECRET = os.environ.get('SECRET', 'default')
          
          # CAMINHO DO SCRIPT NO DESKTOP
          DESKTOP_PATH = os.path.join(os.environ['USERPROFILE'], 'Desktop')
          SCRIPT_PATH = os.path.join(DESKTOP_PATH, 'usar_otimizado.py')
          
          RD_ID = os.environ.get('RUSTDESK_ID', 'N/A')
          RD_PASS = os.environ.get('RUSTDESK_PASSWORD', 'N/A')

          @app.after_request
          def after_request(response):
              response.headers.add('Access-Control-Allow-Origin', '*')
              response.headers.add('Access-Control-Allow-Headers', '*')
              response.headers.add('Access-Control-Allow-Methods', '*')
              return response

          @app.route('/health')
          def health():
              return jsonify({'status': 'online'})

          @app.route('/info', methods=['GET'])
          def info():
              return jsonify({
                  'status': 'online',
                  'rustdesk_id': RD_ID,
                  'rustdesk_password': RD_PASS,
                  'script_loaded': os.path.exists(SCRIPT_PATH)
              })

          @app.route('/webhook', methods=['POST'])
          def webhook():
              data = request.get_json() or {}
              link = data.get('inviteLink')
              amount = data.get('amount')

              print(f"[{datetime.now().strftime('%H:%M:%S')}] üì© Comando: {link} ({amount}x)", flush=True)

              if not link or not amount:
                  return jsonify({'error': 'Dados faltando (inviteLink ou amount)'}), 400
              
              if not os.path.exists(SCRIPT_PATH):
                  return jsonify({'error': 'Script usar_otimizado.py n√£o encontrado no Desktop'}), 500

              try:
                  # MONTA O COMANDO EXATO: python usar_otimizado.py --link "URL" --amount 50
                  cmd = [
                      sys.executable, 
                      SCRIPT_PATH, 
                      "--link", str(link), 
                      "--amount", str(amount)
                  ]
                  
                  # Executa definindo o Desktop como diret√≥rio de trabalho (cwd)
                  # Isso garante que logs ou arquivos gerados fiquem no Desktop
                  subprocess.Popen(cmd, creationflags=subprocess.CREATE_NEW_CONSOLE, cwd=DESKTOP_PATH)
                  
                  return jsonify({
                      'success': True, 
                      'message': 'Automa√ß√£o iniciada',
                      'command': f'python usar_otimizado.py --amount {amount}'
                  })
              except Exception as e:
                  print(f"‚ùå Erro ao iniciar: {e}", flush=True)
                  return jsonify({'success': False, 'error': str(e)}), 500

          if __name__ == '__main__':
              print(f"[{datetime.now().strftime('%H:%M:%S')}] üåê Webhook ON porta 5000...")
              app.run(host='0.0.0.0', port=5000, debug=False)
          '@
          
          $code = $code.Trim()
          Set-Content -Path "$env:TEMP\webhook.py" -Value $code -Encoding UTF8
          Write-Host "‚úÖ Servidor Webhook criado"

      - name: Setup Ngrok
        run: |
          Write-Host "üåê Ngrok setup..."
          $zip = "$env:TEMP\ngrok.zip"
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath "$env:TEMP\ngrok" -Force
          $exe = Get-ChildItem -Path "$env:TEMP\ngrok" -Filter "ngrok.exe" -Recurse | Select-Object -First 1
          & $exe.FullName config add-authtoken "${{ inputs.ngrok_token }}"
          "NGROK_EXE=$($exe.FullName)" | Out-File -Append $env:GITHUB_ENV

      - name: Start Services
        run: |
          $env:SECRET = "${{ inputs.webhook_secret }}"
          $env:RUSTDESK_PASSWORD = "${{ inputs.rustdesk_password }}"
          
          Start-Process python -ArgumentList "$env:TEMP\webhook.py" -WindowStyle Hidden
          Start-Sleep 5
          
          $ngrok = "$env:NGROK_EXE"
          Start-Process $ngrok -ArgumentList "http","5000" -WindowStyle Hidden
          Start-Sleep 8
          
          $url = ""
          for ($i = 1; $i -le 10; $i++) {
            try { $t = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels"; if ($t.tunnels.Count -gt 0) { $url = $t.tunnels[0].public_url; break } } catch { Start-Sleep 2 }
          }
          
          "WEBHOOK_URL=$url" | Out-File -Append $env:GITHUB_ENV
          
          Write-Host ""
          Write-Host "üöÄ SISTEMA ONLINE (DESKTOP MODE)"
          Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          Write-Host "üåê URL da API: $url/info"
          Write-Host "üÜî RustDesk ID: $env:RUSTDESK_ID"
          Write-Host "üìÇ Arquivos salvos em: Desktop"
          Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

      - name: Keep Alive
        run: |
          $m = [int]"${{ inputs.runtime_minutes }}"
          $e = (Get-Date).AddMinutes($m)
          while ((Get-Date) -lt $e) { Start-Sleep 60 }

      - name: Trigger A
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          Write-Host "üîÑ Tempo esgotado! Iniciando B..."
          $payload = @{
            rustdesk_password = "${{ inputs.rustdesk_password }}"
            ngrok_token = "${{ inputs.ngrok_token }}"
            script_url = "${{ inputs.script_url }}"
            webhook_secret = "${{ inputs.webhook_secret }}"
            runtime_minutes = "${{ inputs.runtime_minutes }}"
          }
          $url = "https://api.github.com/repos/${{ github.repository }}/actions/workflows/remote-B.yml/dispatches"
          $h = @{ Authorization = "Bearer $env:GH_TOKEN"; Accept = "application/vnd.github+json" }
          $body = @{ ref = "${{ github.ref_name }}"; inputs = $payload } | ConvertTo-Json -Depth 5 -Compress
          try {
            Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -ContentType "application/json"
            Write-Host "‚úÖ B acionado com sucesso!"
          } catch { Write-Host "‚ùå Erro ao chamar B: $_" }
