name: RustDesk + Webhook B (CORS BLINDADO)

on:
  workflow_dispatch:
    inputs:
      rustdesk_password:
        description: "RustDesk password"
        required: false
        default: "Sunni12345#"
      ngrok_token:
        description: "Ngrok token"
        required: false
        default: "37g5Li5Ku4vdBp9Aj3ff99eqL67_6fHotdD33DTeZgUKdz18B"
      webhook_secret:
        description: "Secret Webhook"
        required: false
        default: "segredo_padrao_123"
      runtime_minutes:
        description: "Runtime"
        required: false
        default: "355"
      auto_restart:
        description: "Auto restart"
        type: boolean
        default: true

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: pwsh

jobs:
  remote:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Install RustDesk
        run: |
          Write-Host "üì¶ Installing RustDesk..."
          $msi = "$env:TEMP\rustdesk.msi"
          Invoke-WebRequest "https://github.com/rustdesk/rustdesk/releases/download/1.3.1/rustdesk-1.3.1-x86_64.msi" -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i","`"$msi`"","/quiet","/norestart" -Wait
          Write-Host "‚úÖ RustDesk installed"

      - name: Configure RustDesk
        run: |
          Write-Host "üîß Setting password..."
          & "C:\Program Files\RustDesk\rustdesk.exe" --password "${{ inputs.rustdesk_password }}" 2>$null
          Start-Sleep 5
          Write-Host "‚úÖ Password set"

      - name: Get RustDesk ID
        run: |
          Write-Host "üÜî Getting ID..."
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe" -ArgumentList "--service"
          Start-Sleep 3
          
          $id = ""
          for ($i = 1; $i -le 5; $i++) {
            try {
              $output = & "C:\Program Files\RustDesk\rustdesk.exe" --get-id 2>&1 | Out-String
              $id = $output.Trim()
              if ($id -match '^\d+$') { break }
            } catch {}
            Start-Sleep 2
          }
          
          if (-not ($id -match '^\d+$')) {
            $configPath = "$env:APPDATA\RustDesk\config\RustDesk2.toml"
            if (Test-Path $configPath) {
              $content = Get-Content $configPath -Raw
              if ($content -match 'id\s*=\s*"(\d+)"') { $id = $matches[1] }
            }
          }
          
          "RUSTDESK_ID=$id" | Out-File -Append $env:GITHUB_ENV
          Write-Host "‚úÖ RustDesk ID: $id"

      - name: Open Firewall
        run: |
          Write-Host "üî• Opening ports..."
          21115..21119 | ForEach-Object {
            netsh advfirewall firewall add rule name="RD-TCP-$_" dir=in action=allow protocol=TCP localport=$_ | Out-Null
          }
          netsh advfirewall firewall add rule name="RD-UDP-21116" dir=in action=allow protocol=UDP localport=21116 | Out-Null
          Write-Host "‚úÖ Firewall OK"

      - name: Start RustDesk
        run: |
          Write-Host "üöÄ Starting RustDesk..."
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe" -WindowStyle Hidden
          Start-Sleep 5
          Write-Host "‚úÖ RustDesk running"

      - name: Screenshot + Upload
        run: |
          Write-Host "üì∏ Screenshot..."
          $path = "$env:TEMP\screen.png"
          Add-Type -AssemblyName System.Windows.Forms, System.Drawing
          $b = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds
          $bmp = New-Object System.Drawing.Bitmap $b.Width, $b.Height
          $g = [System.Drawing.Graphics]::FromImage($bmp)
          $g.CopyFromScreen($b.Location, [System.Drawing.Point]::Empty, $b.Size)
          $bmp.Save($path, [System.Drawing.Imaging.ImageFormat]::Png)
          $g.Dispose(); $bmp.Dispose()
          
          try {
            $r = curl -F "file=@$path" https://store1.gofile.io/uploadFile
            $j = $r | ConvertFrom-Json
            if ($j.status -eq "ok") {
              Write-Host "‚úÖ Screenshot: $($j.data.downloadPage)"
              "SCREENSHOT_URL=$($j.data.downloadPage)" | Out-File -Append $env:GITHUB_ENV
            }
          } catch {
             Write-Host "‚ö†Ô∏è Screenshot upload failed"
          }

      - name: Run Optimization
        run: |
          Write-Host "‚ö° Optimization..."
          try {
            $url = "https://raw.githubusercontent.com/SUNNIESTFOIL64587/otm/refs/heads/main/Otimization.cmd"
            $path = "$env:TEMP\Otimization.cmd"
            Invoke-WebRequest -Uri $url -OutFile $path
            Start-Process cmd.exe -ArgumentList "/c `"$path`"" -Wait -NoNewWindow
            Remove-Item $path -Force
            Write-Host "‚úÖ Optimized"
          } catch {
            Write-Host "‚ö†Ô∏è Optimization failed"
          }

      - name: Install Python + Flask + CORS
        run: |
          Write-Host "üì¶ Installing Flask & CORS..."
          python -m pip install --upgrade pip --quiet
          python -m pip install flask flask-cors --quiet
          Write-Host "‚úÖ Flask + CORS installed"

      - name: Create Webhook Server
        run: |
          $code = @'
          from flask import Flask, request, jsonify
          from flask_cors import CORS
          from datetime import datetime
          import os

          app = Flask(__name__)
          # Configura CORS para aceitar TUDO, inclusive o header do Ngrok
          CORS(app, resources={r"/*": {"origins": "*"}})

          SECRET = os.environ.get('SECRET', 'default')
          RD_ID = os.environ.get('RUSTDESK_ID', 'Not Found')
          RD_PASS = os.environ.get('RUSTDESK_PASSWORD', 'Not Found')

          # --- FOR√áA BRUTA NOS HEADERS (CORRE√á√ÉO DO PROBLEMA) ---
          @app.after_request
          def after_request(response):
              response.headers.add('Access-Control-Allow-Origin', '*')
              response.headers.add('Access-Control-Allow-Headers', 'Content-Type,Authorization,ngrok-skip-browser-warning,X-Webhook-Secret')
              response.headers.add('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE,OPTIONS')
              return response

          requests_log = []

          @app.route('/health')
          def health():
              return jsonify({'status': 'online', 'time': datetime.now().isoformat()})

          @app.route('/info', methods=['GET'])
          def info():
              return jsonify({
                  'status': 'online',
                  'rustdesk_id': RD_ID,
                  'rustdesk_password': RD_PASS,
                  'machine_time': datetime.now().isoformat()
              })

          @app.route('/webhook', methods=['POST'])
          def webhook():
              secret = request.headers.get('X-Webhook-Secret', '')
              # Debug: Se quiser remover a checagem de secret para teste, comente as duas linhas abaixo
              if secret != SECRET:
                  return jsonify({'error': 'Invalid secret'}), 401
              
              data = request.get_json() or {}
              timestamp = datetime.now().isoformat()
              requests_log.append({'time': timestamp, 'data': data})
              
              print(f"[{datetime.now().strftime('%H:%M:%S')}] ‚úÖ Webhook: {data}", flush=True)
              
              with open(r'C:\webhook_requests.txt', 'a', encoding='utf-8') as f:
                  f.write(f"{timestamp} | {data}\n")
              
              return jsonify({
                  'success': True,
                  'message': 'Request received',
                  'data': data
              })

          if __name__ == '__main__':
              print(f"[{datetime.now().strftime('%H:%M:%S')}] üåê Starting webhook server...")
              app.run(host='0.0.0.0', port=5000, debug=False)
          '@
          $code = $code.Trim()
          Set-Content -Path "$env:TEMP\webhook.py" -Value $code -Encoding UTF8
          Write-Host "‚úÖ Webhook server created"

      - name: Setup Ngrok
        run: |
          Write-Host "üåê Ngrok setup..."
          $zip = "$env:TEMP\ngrok.zip"
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath "$env:TEMP\ngrok" -Force
          $exe = Get-ChildItem -Path "$env:TEMP\ngrok" -Filter "ngrok.exe" -Recurse | Select-Object -First 1
          if (-not $exe) { throw "Ngrok exe not found" }
          
          & $exe.FullName config add-authtoken "${{ inputs.ngrok_token }}"
          "NGROK_EXE=$($exe.FullName)" | Out-File -Append $env:GITHUB_ENV
          Write-Host "‚úÖ Ngrok ready"

      - name: Start Webhook + Ngrok
        run: |
          Write-Host "üöÄ Starting webhook..."
          
          $env:SECRET = "${{ inputs.webhook_secret }}"
          $env:RUSTDESK_PASSWORD = "${{ inputs.rustdesk_password }}"
          
          # Start Flask
          Start-Process python -ArgumentList "$env:TEMP\webhook.py" -WindowStyle Hidden
          Start-Sleep 5
          
          # Start Ngrok (STATIC DOMAIN)
          $ngrok = "$env:NGROK_EXE"
          $domain = "debera-obese-interestedly.ngrok-free.dev"
          
          Write-Host "üîó Connecting to static domain: $domain"
          Start-Process $ngrok -ArgumentList "http","--domain=$domain","5000" -WindowStyle Hidden
          Start-Sleep 10
          
          $url = "https://$domain"
          "WEBHOOK_URL=$url" | Out-File -Append $env:GITHUB_ENV
          Write-Host "‚úÖ Webhook URL: $url/webhook"
          Write-Host "‚úÖ Info URL: $url/info"

      - name: Display Info
        run: |
          Write-Host ""
          Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          Write-Host "üÖ∞Ô∏è WORKFLOW A - API MODE (CORS FIX)"
          Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          Write-Host "‚ÑπÔ∏è API Info: $env:WEBHOOK_URL/info"
          Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          Write-Host ""

      - name: Keep Alive
        run: |
          $m = [int]"${{ inputs.runtime_minutes }}"
          if ($m -gt 355) { $m = 355 }
          $e = (Get-Date).AddMinutes($m)
          
          while ((Get-Date) -lt $e) {
            $rem = [math]::Round(($e - (Get-Date)).TotalMinutes, 1)
            Write-Host "[$((Get-Date).ToString('HH:mm:ss'))] [A] ‚úÖ | $rem min"
            Start-Sleep 60
          }
          
          Write-Host "‚è±Ô∏è A completed"

      - name: Trigger B
        if: always() && inputs.auto_restart == true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          Write-Host "üîÑ A->B..."
          
          $payload = @{
            rustdesk_password = "${{ inputs.rustdesk_password }}"
            ngrok_token = "${{ inputs.ngrok_token }}"
            webhook_secret = "${{ inputs.webhook_secret }}"
            runtime_minutes = "${{ inputs.runtime_minutes }}"
            auto_restart = [bool]$true
          }
          
          $url = "https://api.github.com/repos/${{ github.repository }}/actions/workflows/remote-B.yml/dispatches"
          $h = @{ Authorization = "Bearer $env:GH_TOKEN"; Accept = "application/vnd.github+json" }
          $body = @{ ref = "${{ github.ref_name }}"; inputs = $payload } | ConvertTo-Json -Depth 5 -Compress
          
          try {
            Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -ContentType "application/json"
            Write-Host "‚úÖ B triggered successfully"
          } catch {
            Write-Host "‚ùå Failed to trigger B."
          }
