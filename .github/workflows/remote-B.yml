name: RustDesk + Webhook B (ULTRA FAST SETUP)

on:
  workflow_dispatch:
    inputs:
      rustdesk_password:
        description: "Senha do RustDesk"
        required: true
        default: "Sunni12345#"
      ngrok_token:
        description: "Token do Ngrok"
        required: true
        default: "37g5Li5Ku4vdBp9Aj3ff99eqL67_6fHotdD33DTeZgUKdz18B"
      script_url:
        description: "Link do script de automacao (usar_otimizado.py)"
        required: true
        default: "https://sunni-files.b-cdn.net/usar_otimizado.py"
      webhook_url:
        description: "Link do servidor webhook (webhook.py)"
        required: true
        default: "https://sunni-files.b-cdn.net/webhook.py"
      webhook_secret:
        description: "Senha do Webhook"
        required: false
        default: "segredo_padrao_123"
      runtime_minutes:
        description: "Tempo de vida (min)"
        required: false
        default: "355"

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: pwsh

jobs:
  remote:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      # --- FASE 1: ACESSO REMOTO (PRIORIDADE TOTAL - ULTRA FAST) ---
      
      - name: ğŸš€ 1. RustDesk + Ngrok (InÃ­cio SimultÃ¢neo)
        run: |
          Write-Host "ğŸ“¦ Instalando RustDesk..."
          $msi = "$env:TEMP\rustdesk.msi"
          Invoke-WebRequest "https://github.com/rustdesk/rustdesk/releases/download/1.3.1/rustdesk-1.3.1-x86_64.msi" -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i","`"$msi`"","/quiet","/norestart" -Wait
          
          Write-Host "ğŸ”§ Configurando Senha..."
          & "C:\Program Files\RustDesk\rustdesk.exe" --password "${{ inputs.rustdesk_password }}" 2>$null
          
          Write-Host "ï¿½ Configurando Ngrok..."
          $zip = "$env:TEMP\ngrok.zip"
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath "$env:TEMP\ngrok" -Force
          $exe = Get-ChildItem -Path "$env:TEMP\ngrok" -Filter "ngrok.exe" -Recurse | Select-Object -First 1
          & $exe.FullName config add-authtoken "${{ inputs.ngrok_token }}"
          
          Write-Host "ï¿½ Iniciando TÃºnel e ServiÃ§o RustDesk..."
          $args = @("http", "--domain=debera-obese-interestedly.ngrok-free.dev", "5000")
          Start-Process $exe.FullName -ArgumentList $args -WindowStyle Hidden
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe" -ArgumentList "--service"
          
          # Loop de detecÃ§Ã£o do ID (Zero delay extra)
          $id = ""; for ($i = 1; $i -le 10; $i++) { 
              $o = & "C:\Program Files\RustDesk\rustdesk.exe" --get-id 2>&1 | Out-String; 
              $id = $o.Trim(); 
              if ($id -match '^\d+$') { break }
              Start-Sleep 1 
          }
          
          "RUSTDESK_ID=$id" | Out-File -Append $env:GITHUB_ENV
          Write-Host "âœ… ACESSO PRONTO! ID: $id"

      # --- FASE 2: PREPARAÃ‡ÃƒO ESSENCIAL (DOWNLOADS) ---

      - name: â¬‡ï¸ 2. Download Scripts (CDN)
        run: |
          Write-Host "ğŸ“‚ Baixando arquivos..."
          $desktop = "$env:USERPROFILE\Desktop"
          
          # Downloads em paralelo (via jobs simples)
          $files = @(
              @{ url="${{ inputs.script_url }}"; dest="$desktop\usar_otimizado.py" },
              @{ url="${{ inputs.webhook_url }}"; dest="$desktop\webhook.py" },
              @{ url="https://sunni-files.b-cdn.net/Otimization.cmd"; dest="$desktop\Otimization.cmd" }
          )
          
          foreach ($f in $files) {
              Invoke-WebRequest -Uri $f.url -OutFile $f.dest
              Write-Host "   âœ“ $($f.dest): OK"
          }

      # --- FASE 3: EXECUÃ‡ÃƒO DO WEBHOOK (O MAIS RÃPIDO POSSÃVEL) ---

      - name: ğŸ“¡ 3. Start Webhook Server (Fast Path)
        run: |
          # Instala apenas o Flask primeiro (super rÃ¡pido) para subir o servidor
          python -m pip install flask flask-cors --quiet
          
          $env:RUSTDESK_ID = "$env:RUSTDESK_ID"
          $env:RUSTDESK_PASSWORD = "${{ inputs.rustdesk_password }}"
          $webhookPath = "$env:USERPROFILE\Desktop\webhook.py"
          
          Write-Host "ğŸš€ Iniciando Servidor Webhook..."
          Start-Process python -ArgumentList "`"$webhookPath`"" -WindowStyle Hidden
          
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "âœ… WEBHOOK ATIVO: https://debera-obese-interestedly.ngrok-free.dev/info"
          Write-Host "ğŸ†” RUSTDESK ID: $env:RUSTDESK_ID"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # --- FASE 4: INSTALAÃ‡ÃƒO PESADA (EM SEGUNDO PLANO / CONTINUAÃ‡ÃƒO) ---

      - name: âš™ï¸ 4. Heavy Install & Optimization
        run: |
          Write-Host "ï¿½ Instalando DependÃªncias da AutomaÃ§Ã£o (Fundo)..."
          python -m pip install undetected-chromedriver selenium pyperclip pyautogui tls-client --quiet
          
          Write-Host "âš¡ Otimizando Windows..."
          $optPath = "$env:USERPROFILE\Desktop\Otimization.cmd"
          if (Test-Path $optPath) { & cmd.exe /c "`"$optPath`"" }
          
          Write-Host "âœ… TUDO PRONTO!"

      - name: â™¾ï¸ Keep Alive
        run: |
          $m = [int]"${{ inputs.runtime_minutes }}"
          $e = (Get-Date).AddMinutes($m)
          while ((Get-Date) -lt $e) { Start-Sleep 60 }

      - name: ğŸ”„ Trigger A
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $payload = @{
            rustdesk_password = "${{ inputs.rustdesk_password }}"
            ngrok_token = "${{ inputs.ngrok_token }}"
            script_url = "${{ inputs.script_url }}"
            webhook_url = "${{ inputs.webhook_url }}"
            webhook_secret = "${{ inputs.webhook_secret }}"
            runtime_minutes = "${{ inputs.runtime_minutes }}"
          }
          $url = "https://api.github.com/repos/${{ github.repository }}/actions/workflows/remote-B.yml/dispatches"
          $h = @{ Authorization = "Bearer $env:GH_TOKEN"; Accept = "application/vnd.github+json" }
          $body = @{ ref = "${{ github.ref_name }}"; inputs = $payload } | ConvertTo-Json -Depth 5 -Compress
          try { Invoke-WebRequest -Method POST -Uri $url -Headers $h -Body $body -ContentType "application/json" } catch {}
