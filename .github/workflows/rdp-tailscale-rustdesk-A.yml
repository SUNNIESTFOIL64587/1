name: RDP + RustDesk (forced ID + watchdog + print)

on:
  workflow_dispatch:
    inputs:
      runtime_min:
        description: "Minutes to keep alive (≤ 350)"
        required: false
        default: "120"

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Create Admin Users
        run: |
          foreach ($u in @("Sunni1","Sunni2")) {
            $p = ConvertTo-SecureString "Sunn1!GitHub2025#" -AsPlainText -Force
            if (!(Get-LocalUser -Name $u -EA 0)) {
              New-LocalUser $u -Password $p -AccountNeverExpires
            }
            Add-LocalGroupMember -Group Administrators -Member $u
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          }
          Set-ItemProperty `
            -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
            -Name fDenyTSConnections `
            -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Install RustDesk
        run: |
          $msi = "$env:TEMP\rd.msi"
          Invoke-WebRequest `
            -Uri "https://github.com/rustdesk/rustdesk/releases/download/1.3.1/rustdesk-1.3.1-x86_64.msi" `
            -OutFile $msi
          Start-Process msiexec `
            -Arg "/i","`"$msi`"","/quiet","/norestart" `
            -Wait
          21115..21119 | ForEach-Object {
            netsh advfirewall firewall add rule `
              name="RD-$_" `
              dir=in `
              action=allow `
              protocol=TCP `
              localport=$_
          }
          netsh advfirewall firewall add rule `
            name="RD-UDP" `
            dir=in `
            action=allow `
            protocol=UDP `
            localport=21116

      - name: Force config file (garante ID/senha)
        run: |
          $confDir  = "$env:APPDATA\RustDesk\config"
          $confFile = "$confDir\RustDesk2.toml"
          New-Item -ItemType Directory -Force -Path $confDir | Out-Null

          # Gera ID aleatório de 9 dígitos e senha fixa de 6
          $id = (Get-Random -Minimum 100000000 -Maximum 999999999).ToString()
          $pw = "654321"

          @"
id = "$id"
password = "$pw"
"@ | Out-File $confFile -Encoding utf8

          Write-Host "==================================="
          Write-Host "RustDesk ID:  $id"
          Write-Host "Password:     $pw"
          Write-Host "==================================="

      - name: Start RustDesk Service
        run: |
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe" --server
          Start-Sleep 5
          sc.exe config RustDesk start= auto
          sc.exe start RustDesk

      - name: Screenshot (fallback visual)
        run: |
          Add-Type -AssemblyName System.Windows.Forms, System.Drawing
          Start-Sleep 3

          $b = New-Object System.Drawing.Bitmap(
            [System.Windows.Forms.Screen]::PrimaryScreen.Bounds.Width,
            [System.Windows.Forms.Screen]::PrimaryScreen.Bounds.Height
          )

          $g = [System.Drawing.Graphics]::FromImage($b)
          $g.CopyFromScreen(0, 0, 0, 0, $b.Size)
          $g.Dispose()

          $png = "$env:TEMP\desktop.png"
          $b.Save($png)

          Write-Host "Screenshot saved: $png"

          $bytes = [System.IO.File]::ReadAllBytes($png)
          $b64   = [Convert]::ToBase64String($bytes)

          Write-Host "SCREENSHOT_BASE64_START"
          Write-Host $b64
          Write-Host "SCREENSHOT_BASE64_END"

      - name: Watchdog (renova atividade a cada 55 min)
        run: |
          $run = [int]"${{ inputs.runtime_min }}"
          if ($run -gt 350) {
            $run = 350
          }

          $end = (Get-Date).AddMinutes($run)

          while ((Get-Date) -lt $end) {
            Get-Date | Write-Host
            Get-ChildItem "$env:TEMP" |
              Select-Object -First 1 |
              ForEach-Object { $_.LastWriteTime = Get-Date }
            Start-Sleep (55 * 60)
          }
