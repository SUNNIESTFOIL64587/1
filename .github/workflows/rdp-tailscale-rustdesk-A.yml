name: RDP + RustDesk (clean + print + watchdog)

on:
  workflow_dispatch:
    inputs:
      runtime_min:
        description: "Minutes to keep alive"
        required: false
        default: "120"

permissions: { contents: read }

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: Create Admin Users
        run: |
          foreach ($u in @("Sunni1","Sunni2")){
            $p = ConvertTo-SecureString "Sunn1!GitHub2025#" -AsPlainText -Force
            if (!(Get-LocalUser -Name $u -EA 0)){ New-LocalUser $u -Password $p -AccountNeverExpires }
            Add-LocalGroupMember -Group Administrators -Member $u
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          }
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Install RustDesk
        run: |
          $msi = "$env:TEMP\rd.msi"
          Invoke-WebRequest -Uri "https://github.com/rustdesk/rustdesk/releases/download/1.3.1/rustdesk-1.3.1-x86_64.msi" -OutFile $msi
          Start-Process msiexec -Arg "/i","`"$msi`"","/quiet","/norestart" -Wait
          21115..21119 | %{ netsh advfirewall firewall add rule name="RD-$_" dir=in action=allow protocol=TCP localport=$_ }
          netsh advfirewall firewall add rule name="RD-UDP" dir=in action=allow protocol=UDP localport=21116

      - name: Start RustDesk & Grab Credentials
        run: |
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe"
          Start-Sleep 15
          $conf = "$env:APPDATA\RustDesk\config\RustDesk2.toml"
          $id = (Get-Content $conf -EA 0 | sls '^id' ) -replace '\D',''
          $pw = (Get-Content $conf -EA 0 | sls '^password' ) -replace '.+=(.+)','$1'
          Write-Host "==================================="
          Write-Host "RustDesk ID:  $id"
          Write-Host "Password:     $pw"
          Write-Host "==================================="
          # Salva também num txt pra garantir
          "ID:$id`nPW:$pw" | Out-File "$env:TEMP\rd.txt" -Encoding utf8

      - name: Screenshot (fallback)
        run: |
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          Start-Sleep 5
          $b = New-Object System.Drawing.Bitmap([System.Windows.Forms.Screen]::PrimaryScreen.Bounds.Width,
                                                [System.Windows.Forms.Screen]::PrimaryScreen.Bounds.Height)
          $g = [System.Drawing.Graphics]::FromImage($b)
          $g.CopyFromScreen(0,0,0,0,$b.Size)
          $g.Dispose()
          $path = "$env:TEMP\desktop.png"
          $b.Save($path)
          Write-Host "Screenshot saved to $path"
          # Converte para base64 e joga no log (você copia e decoda depois)
          $bytes = [System.IO.File]::ReadAllBytes($path)
          $b6464 = [Convert]::ToBase64String($bytes)
          Write-Host "SCREENSHOT_BASE64_START"
          Write-Host $b64
          Write-Host "SCREENSHOT_BASE64_END"

      - name: Watchdog (evita morte em 360 min)
        run: |
          $run = [int]"${{ github.event.inputs.runtime_min }}"
          if ($run -gt 350){ $run = 350 }   # deixa margem pro job morrer antes dos 360
          $end = (Get-Date).AddMinutes($run)
          $file = "$env:TEMP\keepalive.txt"
          while ((Get-Date) -lt $end){
            $ts = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
            "$ts  still running" | Out-File $file -Append
            Start-Sleep 60
          }
