name: RustDesk with Fixed Credentials

on:
  workflow_dispatch:
    inputs:
      rustdesk_password:
        description: "RustDesk password (choose your own)"
        required: true
        default: "SuaSenhaAqui123"
      runtime_minutes:
        description: "Runtime in minutes (max 360)"
        required: false
        default: "120"

permissions:
  contents: read

defaults:
  run:
    shell: pwsh

jobs:
  remote:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Install RustDesk
        run: |
          Write-Host "ğŸ“¦ Installing RustDesk..."
          $msi = "$env:TEMP\rustdesk.msi"
          Invoke-WebRequest https://github.com/rustdesk/rustdesk/releases/download/1.3.1/rustdesk-1.3.1-x86_64.msi -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i","`"$msi`"","/quiet","/norestart" -Wait
          Write-Host "âœ… RustDesk installed"

      - name: Configure RustDesk with Fixed Password
        run: |
          Write-Host "ğŸ”§ Configuring RustDesk..."
          $password = "${{ inputs.rustdesk_password }}"
          
          # Set permanent password
          & "C:\Program Files\RustDesk\rustdesk.exe" --password "$password"
          Start-Sleep 3
          
          # Get permanent ID
          $config = & "C:\Program Files\RustDesk\rustdesk.exe" --get-id
          Start-Sleep 2
          
          Write-Host "âœ… RustDesk configured!"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ğŸ†” RUSTDESK ID: $config"
          Write-Host "ğŸ”‘ PASSWORD: $password"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Open Firewall Ports
        run: |
          Write-Host "ğŸ”¥ Opening firewall ports..."
          21115..21119 | ForEach-Object {
            netsh advfirewall firewall add rule name="RD-TCP-$_" dir=in action=allow protocol=TCP localport=$_ | Out-Null
          }
          netsh advfirewall firewall add rule name="RD-UDP-21116" dir=in action=allow protocol=UDP localport=21116 | Out-Null
          Write-Host "âœ… Firewall configured"

      - name: Start RustDesk Service
        run: |
          Write-Host "ğŸš€ Starting RustDesk service..."
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe" -ArgumentList "--service"
          Start-Sleep 5
          
          # Also start GUI
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe"
          Start-Sleep 5
          Write-Host "âœ… RustDesk running!"

      - name: Display Connection Info
        run: |
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          Write-Host "â•‘  ğŸ¯ CONNECT TO YOUR MACHINE NOW!          â•‘"
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host ""
          Write-Host "1ï¸âƒ£  Download RustDesk client: https://rustdesk.com/download"
          Write-Host "2ï¸âƒ£  Use the ID and password shown above"
          Write-Host "3ï¸âƒ£  Connection is active for ${{ inputs.runtime_minutes }} minutes"
          Write-Host ""

      - name: Take Screenshot
        run: |
          Write-Host "ğŸ“¸ Taking screenshot..."
          Add-Type -AssemblyName System.Windows.Forms, System.Drawing
          $b = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds
          $bmp = New-Object System.Drawing.Bitmap $b.Width, $b.Height
          $g = [System.Drawing.Graphics]::FromImage($bmp)
          $g.CopyFromScreen($b.Location,[System.Drawing.Point]::Empty,$b.Size)
          $png = "$env:TEMP\screen.png"
          $bmp.Save($png,[System.Drawing.Imaging.ImageFormat]::Png)
          $g.Dispose(); $bmp.Dispose()

          $r = curl -s -F "file=@$png" https://store1.gofile.io/uploadFile
          $j = $r | ConvertFrom-Json
          if ($j.status -eq "ok") {
            Write-Host "âœ… Screenshot: $($j.data.downloadPage)"
          }

      - name: Keep Alive
        run: |
          $m = [int]"${{ inputs.runtime_minutes }}"
          if ($m -gt 360) { $m = 360 }
          $e = (Get-Date).AddMinutes($m)
          
          Write-Host ""
          Write-Host "â° Session will end at: $e"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          while ((Get-Date) -lt $e) {
            $remaining = [math]::Round(($e - (Get-Date)).TotalMinutes, 1)
            Write-Host "âœ… Alive | $remaining min remaining | $(Get-Date -Format 'HH:mm:ss')"
            Start-Sleep 60
          }
          
          Write-Host ""
          Write-Host "â±ï¸  Session expired. Goodbye!"
