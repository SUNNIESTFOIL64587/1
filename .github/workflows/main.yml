name: RustDesk Remote Access

on:
  workflow_dispatch:
    inputs:
      rustdesk_password:
        description: "RustDesk password"
        required: true
        default: "SUNNI12345#"
      runtime_minutes:
        description: "Runtime in minutes (max 360)"
        required: false
        default: "350"

permissions:
  contents: read

defaults:
  run:
    shell: pwsh

jobs:
  remote:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Install RustDesk
        run: |
          Write-Host "ğŸ“¦ Installing RustDesk..."
          $msi = "$env:TEMP\rustdesk.msi"
          Invoke-WebRequest https://github.com/rustdesk/rustdesk/releases/download/1.3.1/rustdesk-1.3.1-x86_64.msi -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i","`"$msi`"","/quiet","/norestart" -Wait
          Write-Host "âœ… RustDesk installed"

      - name: Configure RustDesk Password
        run: |
          Write-Host "ğŸ”§ Setting RustDesk password..."
          $password = "${{ inputs.rustdesk_password }}"
          
          # Set password
          & "C:\Program Files\RustDesk\rustdesk.exe" --password "$password" 2>$null
          Start-Sleep 5
          
          Write-Host "âœ… Password configured: $password"

      - name: Get RustDesk ID
        run: |
          Write-Host "ğŸ†” Getting RustDesk ID..."
          
          # Start RustDesk service first
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe" -ArgumentList "--service"
          Start-Sleep 3
          
          # Get ID with multiple attempts
          $id = ""
          for ($i = 1; $i -le 5; $i++) {
            try {
              $output = & "C:\Program Files\RustDesk\rustdesk.exe" --get-id 2>&1 | Out-String
              $id = $output.Trim()
              if ($id -match '^\d+$') {
                break
              }
            } catch {}
            Write-Host "Attempt $i..."
            Start-Sleep 2
          }
          
          # If still no ID, read from config file
          if (-not ($id -match '^\d+$')) {
            $configPath = "$env:APPDATA\RustDesk\config\RustDesk2.toml"
            if (Test-Path $configPath) {
              $content = Get-Content $configPath -Raw
              if ($content -match 'id\s*=\s*"(\d+)"') {
                $id = $matches[1]
              }
            }
          }
          
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ğŸ†” RUSTDESK ID: $id"
          Write-Host "ğŸ”‘ PASSWORD: ${{ inputs.rustdesk_password }}"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host ""

      - name: Open Firewall Ports
        run: |
          Write-Host "ğŸ”¥ Opening firewall ports..."
          21115..21119 | ForEach-Object {
            netsh advfirewall firewall add rule name="RD-TCP-$_" dir=in action=allow protocol=TCP localport=$_ | Out-Null
          }
          netsh advfirewall firewall add rule name="RD-UDP-21116" dir=in action=allow protocol=UDP localport=21116 | Out-Null
          Write-Host "âœ… Firewall configured"

      - name: Start RustDesk GUI
        run: |
          Write-Host "ğŸš€ Starting RustDesk..."
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe"
          Start-Sleep 5
          Write-Host "âœ… RustDesk is running"

      - name: Take Screenshot
        continue-on-error: true
        run: |
          Write-Host "ğŸ“¸ Taking screenshot..."
          try {
            Add-Type -AssemblyName System.Windows.Forms, System.Drawing
            $b = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds
            $bmp = New-Object System.Drawing.Bitmap $b.Width, $b.Height
            $g = [System.Drawing.Graphics]::FromImage($bmp)
            $g.CopyFromScreen($b.Location,[System.Drawing.Point]::Empty,$b.Size)
            $png = "$env:TEMP\screen.png"
            $bmp.Save($png,[System.Drawing.Imaging.ImageFormat]::Png)
            $g.Dispose(); $bmp.Dispose()

            Write-Host "ğŸ“¤ Uploading screenshot..."
            $response = Invoke-RestMethod -Uri "https://store1.gofile.io/uploadFile" -Method Post -Form @{file = Get-Item $png}
            
            if ($response.status -eq "ok") {
              Write-Host "âœ… Screenshot: $($response.data.downloadPage)"
            } else {
              Write-Host "âš ï¸ Screenshot upload failed"
            }
          } catch {
            Write-Host "âš ï¸ Screenshot failed: $($_.Exception.Message)"
          }

      - name: Keep Alive
        run: |
          $m = [int]"${{ inputs.runtime_minutes }}"
          if ($m -gt 360) { $m = 360 }
          $e = (Get-Date).AddMinutes($m)
          
          Write-Host ""
          Write-Host "â° Session active until: $e"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host ""
          
          while ((Get-Date) -lt $e) {
            $remaining = [math]::Round(($e - (Get-Date)).TotalMinutes, 1)
            Write-Host "âœ… [$((Get-Date).ToString('HH:mm:ss'))] Session alive | $remaining minutes remaining"
            Start-Sleep 60
          }
          
          Write-Host ""
          Write-Host "â±ï¸ Session ended"
