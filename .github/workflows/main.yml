name: RDP + RustDesk + Screenshot

on:
  workflow_dispatch:
    inputs:
      runtime_minutes:
        description: "Runtime (max 360)"
        required: false
        default: "120"

permissions:
  contents: read

defaults:
  run:
    shell: pwsh

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Create user and enable RDP
        run: |
          $u = "runner"
          $p = "Runner@123456"
          if (-not (Get-LocalUser -Name $u -EA SilentlyContinue)) {
            New-LocalUser -Name $u -Password (ConvertTo-SecureString $p -AsPlainText -Force) -AccountNeverExpires
            Add-LocalGroupMember -Group Administrators -Member $u
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          }
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" | Out-Null

      - name: Install RustDesk
        run: |
          $exe = "C:\Program Files\RustDesk\rustdesk.exe"
          if (-not (Test-Path $exe)) {
            $url = "https://github.com/rustdesk/rustdesk/releases/download/1.3.1/rustdesk-1.3.1-x86_64.msi"
            $msi = "$env:TEMP\rustdesk.msi"
            Invoke-WebRequest -Uri $url -OutFile $msi
            Start-Process msiexec.exe -ArgumentList "/i","`"$msi`"","/quiet","/norestart" -Wait
          }

      - name: Open RustDesk ports
        run: |
          21115..21119 | ForEach-Object {
            netsh advfirewall firewall add rule name="RD-TCP-$_" dir=in action=allow protocol=TCP localport=$_
          }
          netsh advfirewall firewall add rule name="RD-UDP-21116" dir=in action=allow protocol=UDP localport=21116

      - name: Start RustDesk
        run: |
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe"
          Start-Sleep 10

      - name: Screenshot + Upload GoFile
        run: |
          Add-Type -AssemblyName System.Windows.Forms, System.Drawing
          $bounds = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds
          $bmp = New-Object System.Drawing.Bitmap $bounds.Width, $bounds.Height
          $gfx = [System.Drawing.Graphics]::FromImage($bmp)
          $gfx.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $png = "$env:TEMP\screenshot.png"
          $bmp.Save($png, [System.Drawing.Imaging.ImageFormat]::Png)
          $gfx.Dispose()
          $bmp.Dispose()
          $resp = curl.exe -s -L -F "file=@$png" https://store1.gofile.io/uploadFile
          if ($resp -match '\{.*\}') {
            $json = $resp | ConvertFrom-Json
            if ($json.status -eq "ok") {
              Write-Host "SCREENSHOT_URL=$($json.data.downloadPage)"
            }
          }

      - name: Keep alive
        run: |
          $mins = [int]"${{ inputs.runtime_minutes }}"
          if ($mins -gt 360) { $mins = 360 }
          $end = (Get-Date).AddMinutes($mins)
          while ((Get-Date) -lt $end) {
            Write-Host "Alive $(Get-Date)"
            Start-Sleep 60
          }
